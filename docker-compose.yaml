services:
  # Nginx reverse proxy with automatic SSL
  nginx:
    image: nginx:alpine
    container_name: nginx
    restart: unless-stopped
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    environment:
      - DOMAIN=${DOMAIN:-localhost}
      - EMAIL=${SSL_EMAIL:-admin@example.com}
      - AUTO_GENERATE_CONFIG=true
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/generate-config.sh:/etc/nginx/generate-config.sh:ro
      - ./nginx/docker-entrypoint.sh:/docker-entrypoint.sh:ro
      - ./certbot/www:/var/www/certbot:rw
      - ./certbot/conf:/etc/letsencrypt:rw
    entrypoint: ["/docker-entrypoint.sh"]
    depends_on:
      - webapi
    networks:
      - app-network

  # Certbot для получения SSL сертификатов
  certbot:
    image: certbot/certbot:latest
    container_name: certbot
    volumes:
      - ./certbot/www:/var/www/certbot:rw
      - ./certbot/conf:/etc/letsencrypt:rw
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

  # API сервис (C# Web API)
  webapi:
    container_name: webapi
    build:
      context: ./api
      dockerfile: Dockerfile
    expose:
      - "8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Production}
      - ASPNETCORE_URLS=http://+:8080
      - PythonService__Url=${PYTHON_SERVICE_URL:-http://geocode-service:50051}
      - AddressParserService__Url=${ADDRESS_PARSER_URL:-http://address-parser:50052}
      - ASPNETCORE_FORWARDEDHEADERS_ENABLED=true
    depends_on:
      geocode-service:
        condition: service_healthy
      address-parser:
        condition: service_healthy
    networks:
      - app-network

  # Python Geocode сервис (поиск адресов)
  geocode-service:
    container_name: geocode-service
    build:
      context: ./python-search
      dockerfile: Dockerfile
    ports:
      - "${GEOCODE_SERVICE_PORT:-50051}:50051"
    environment:
      - GRPC_PORT=${GEOCODE_SERVICE_GRPC_PORT:-50051}
      - PYTHONUNBUFFERED=1
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "python", "-c", "import grpc; channel = grpc.insecure_channel('localhost:50051'); channel.close()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Address Parser сервис (libpostal)
  address-parser:
    container_name: address-parser
    build:
      context: ./address-parser
      dockerfile: Dockerfile
    ports:
      - "${ADDRESS_PARSER_PORT:-50052}:50052"
    environment:
      - GRPC_PORT=${ADDRESS_PARSER_GRPC_PORT:-50052}
      - PYTHONUNBUFFERED=1
    networks:
      - app-network
    # libpostal требует много памяти при загрузке данных
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
    healthcheck:
      test: ["CMD", "python", "-c", "import grpc; channel = grpc.insecure_channel('localhost:50052'); channel.close()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    volumes:
      # Кэшируем данные libpostal для быстрого перезапуска
      - libpostal-data:/usr/local/share/libpostal

networks:
  app-network:
    driver: bridge

volumes:
  libpostal-data:
    driver: local
