services:
  # Nginx reverse proxy with automatic SSL
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: nginx
    restart: unless-stopped
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    environment:
      - DOMAIN=${DOMAIN:-localhost}
      - EMAIL=${SSL_EMAIL:-admin@example.com}
      - AUTO_GENERATE_CONFIG=true
      - CERTBOT_STAGING=${CERTBOT_STAGING:-0}
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      # ВАЖНО: Используем именованные volumes для сохранения сертификатов между деплоями
      - certbot-conf:/etc/letsencrypt
      - certbot-www:/var/www/certbot
    depends_on:
      - webapi
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Certbot для получения SSL сертификатов
  certbot:
    image: certbot/certbot:latest
    container_name: certbot
    volumes:
      # ВАЖНО: Используем те же именованные volumes что и nginx
      - certbot-conf:/etc/letsencrypt
      - certbot-www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew --quiet; sleep 12h & wait $${!}; done;'"
    depends_on:
      - nginx
    networks:
      - app-network

  # API сервис (C# Web API)
  webapi:
    container_name: webapi
    build:
      context: ./api
      dockerfile: Dockerfile
    ports:
      - "5000:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Production}
      - ASPNETCORE_URLS=http://+:8080
      - PYTHON_SERVICE_URL=${PYTHON_SERVICE_URL:-http://geocode-service:50054}
      - ASPNETCORE_FORWARDEDHEADERS_ENABLED=true
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:5000,http://localhost:5175,http://localhost:3000}
    depends_on:
      geocode-service:
        condition: service_healthy
    networks:
      - app-network

  # OSM SQLite сервис (конвертирует OSM → SQLite)
  osm-db:
    container_name: osm-db
    build:
      context: .
      dockerfile: ./sqlLiteBuilder/Dockerfile
      args:
        - OSM_FILE_NAME=${OSM_FILE_NAME:-10-moscow.osm.pbf}
    ports:
      - "${OSM_DB_PORT:-8091}:8091"
    environment:
      - PYTHONUNBUFFERED=1
      - OSM_FILE_NAME=${OSM_FILE_NAME:-10-moscow.osm.pbf}
    networks:
      - app-network
    volumes:
      # Общая БД для всех сервисов
      - osm-db-data:/data/db
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8091/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 300s  # 5 минут на первую конвертацию

  # Address Parser (libpostal для парсинга адресов)
  address-parser:
    container_name: address-parser
    build:
      context: ./address-parser
      dockerfile: Dockerfile
    ports:
      - "50052:50052"
    environment:
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    networks:
      - app-network
    deploy:
      resources:
        limits:
          memory: 2G  # Увеличено для libpostal
        reservations:
          memory: 512M
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import socket; s = socket.socket(socket.AF_INET, socket.SOCK_STREAM); s.settimeout(5); result = s.connect_ex((\"localhost\", 50052)); s.close(); exit(0 if result == 0 else 1)'"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 180s  # 3 минуты для скачивания libpostal данных

  # Address Corrector (исправление опечаток с libpostal)
  address-corrector:
    container_name: address-corrector
    build:
      context: ./address-corrector
      dockerfile: Dockerfile
    ports:
      - "50053:50053"
    volumes:
      - osm-db-data:/data/db
    environment:
      - DB_PATH=/data/db/moscow.db
      - PYTHONUNBUFFERED=1
      - GRPC_PORT=50053
    depends_on:
      osm-db:
        condition: service_healthy
      address-parser:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - app-network
    deploy:
      resources:
        limits:
          memory: 2G  # Увеличено для libpostal + создания словарей
        reservations:
          memory: 512M
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import socket; s = socket.socket(socket.AF_INET, socket.SOCK_STREAM); s.settimeout(5); result = s.connect_ex((\"localhost\", 50053)); s.close(); exit(0 if result == 0 else 1)'"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 180s  # 3 минуты для скачивания libpostal данных + создания FTS5 словарей

  # Geocode сервис (хакатон - FTS5 + Levenshtein)
  geocode-service:
    container_name: geocode-service
    build:
      context: ./geocode-service
      dockerfile: Dockerfile
    ports:
      - "50054:50054"
    volumes:
      # Использует БД от osm-db (read-write для инициализации таблиц)
      - osm-db-data:/data/db
    environment:
      - DB_PATH=/data/db/moscow.db
      - PYTHONUNBUFFERED=1
      - ADDRESS_PARSER_URL=address-parser:50052
      - ADDRESS_CORRECTOR_URL=address-corrector:50053
    depends_on:
      osm-db:
        condition: service_healthy
      address-parser:
        condition: service_healthy
      address-corrector:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - app-network
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import socket; s = socket.socket(socket.AF_INET, socket.SOCK_STREAM); s.settimeout(5); result = s.connect_ex((\"localhost\", 50054)); s.close(); exit(0 if result == 0 else 1)'"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 60s  # Время для инициализации БД и подключения к сервисам

networks:
  app-network:
    driver: bridge

volumes:
  osm-db-data:
    driver: local
  # SSL сертификаты - сохраняются между деплоями
  certbot-conf:
    driver: local
  certbot-www:
    driver: local
