# Демонстрационные примеры для жюри

## Формат API запросов

### REST Endpoint (SSE - Server-Sent Events)
```
GET http://localhost:5000/api/geocode/stream?query={адрес}&limit=10
```

### gRPC Endpoint (для программного доступа)
```
host: localhost:50054
method: SearchAddress
```

---

## Примеры запросов и ответов

### Пример 1: Точный адрес (полная форма)

**Запрос:**
```bash
curl "http://localhost:5000/api/geocode/stream?query=Москва,%20улица%20Арбат,%2010&limit=5"
```

**Ожидаемый ответ** (формат хакатона):
```json
{
  "searched_address": "Москва, улица Арбат, 10",
  "objects": [
    {
      "locality": "Москва",
      "street": "улица Арбат",
      "number": "10",
      "lon": 37.5964,
      "lat": 55.7512,
      "score": 0.95
    }
  ]
}
```

---

### Пример 2: Краткая форма (без "Москва" и "улица")

**Запрос:**
```bash
curl "http://localhost:5000/api/geocode/stream?query=Арбат%2010&limit=5"
```

**Ожидаемый ответ:**
```json
{
  "searched_address": "Арбат 10",
  "objects": [
    {
      "locality": "Москва",
      "street": "улица Арбат",
      "number": "10",
      "lon": 37.5964,
      "lat": 55.7512,
      "score": 0.91
    }
  ]
}
```

**Примечание:** Score ниже из-за неполной формы запроса, но адрес найден корректно.

---

### Пример 3: Опечатка в адресе

**Запрос:**
```bash
curl "http://localhost:5000/api/geocode/stream?query=Арбот%2010&limit=5"
```

**Что происходит:**
1. LibPostal парсит: `{"road": "", "house_number": "10"}`
2. FTS5 поиск по "арбот" + "10"
3. Умная коррекция (если score < 28%): "Арбот" → "Арбат"
4. Повторный поиск с исправленным адресом

**Ожидаемый ответ:**
```json
{
  "searched_address": "Арбот 10",
  "objects": [
    {
      "locality": "Москва",
      "street": "улица Арбат",
      "number": "10",
      "lon": 37.5964,
      "lat": 55.7512,
      "score": 0.75
    }
  ]
}
```

---

### Пример 4: Только улица (без номера дома)

**Запрос:**
```bash
curl "http://localhost:5000/api/geocode/stream?query=Тверская&limit=5"
```

**Ожидаемый ответ:**
```json
{
  "searched_address": "Тверская",
  "objects": [
    {
      "locality": "Москва",
      "street": "Тверская улица",
      "number": "1",
      "lon": 37.6094,
      "lat": 55.7580,
      "score": 0.45
    },
    {
      "locality": "Москва",
      "street": "Тверская улица",
      "number": "2",
      "lon": 37.6095,
      "lat": 55.7581,
      "score": 0.45
    }
  ]
}
```

**Примечание:** Возвращает все дома на улице Тверская, упорядоченные по relevance.

---

### Пример 5: Адрес не найден

**Запрос:**
```bash
curl "http://localhost:5000/api/geocode/stream?query=Несуществующая%20улица%20999&limit=5"
```

**Ожидаемый ответ** (требование хакатона):
```json
{
  "searched_address": "Несуществующая улица 999",
  "objects": []
}
```

**HTTP код:** 200 OK (НЕ 404!)

---

## Демонстрация метрики Левенштейна

### Формула из ТЗ:
```
score = 1 - L(A_pred, A_true) / max(len(A_pred), len(A_true))
```

### Пример расчета:

**Запрос:** "Арбат 10"
**Найдено:** "Москва, улица Арбат, 10"

**Нормализация для сравнения:**
- Входной: "арбат 10" → нормализовано: "10 арбат" (сортировка слов)
- Из БД: "Москва, улица Арбат, 10" → нормализовано: "10 арбат москва"

**Расчет:**
```
L("10 арбат", "10 арбат москва") = 7 (добавлено " москва")
max_len = max(9, 16) = 16
lev_score = 1 - 7/16 = 1 - 0.4375 = 0.5625 (56.25%)
```

**Итоговый score:** комбинация Levenshtein + BM25 + component matching ≈ **0.91** (91%)

---

## Демонстрация нормализации адресов

### Из БД (правильный формат):
```
Москва, Дорожная улица, 50 к1 с15
Москва, Дмитровское шоссе, 165Б
Москва, Правобережная улица, 1Б
```

✅ **Соответствует требованию:** `{город}, {улица}, {номер дома} {корпус} {строение}`

---

## Тестирование через curl

### Быстрый тест:
```bash
# 1. Точный адрес
curl "http://localhost:5000/api/geocode/stream?query=Москва,%20улица%20Арбат,%2010"

# 2. Краткая форма
curl "http://localhost:5000/api/geocode/stream?query=Арбат%2010"

# 3. Только улица
curl "http://localhost:5000/api/geocode/stream?query=Тверская"

# 4. Опечатка
curl "http://localhost:5000/api/geocode/stream?query=Тверска%2012"

# 5. Не найден
curl "http://localhost:5000/api/geocode/stream?query=fake%20street%20999"
```

---

## Метрики производительности

### Ожидаемое время ответа:
- **Простой запрос** (без коррекции): 50-100ms
- **С исправлением опечаток** (corrector): 150-250ms
- **Ограничение ТЗ:** ~100ms (адекватное время)

### Оптимизации:
1. FTS5 индексы для быстрого поиска
2. Умная коррекция (только если score < 28%)
3. Кеширование списка городов
4. Batch processing для вставки данных

---

## Статистика данных

**База данных:**
- Всего зданий: **141,214**
- С адресами: **100%**
- Полные названия (без сокращений): **99.998%**
- Источник: OpenStreetMap (Moscow, pbf)

---

## Для жюри: Быстрый запуск

```bash
# 1. Клонировать репозиторий
git clone <repo-url>
cd best_hack25

# 2. Запустить все сервисы
docker compose up -d --build

# 3. Дождаться готовности (5-10 минут для первой конвертации OSM)
docker compose logs -f osm-db

# 4. Проверить здоровье
curl http://localhost:5000/api/geocode/stream?query=Арбат%2010

# 5. Открыть веб-интерфейс
http://localhost:5000
```

**Порты:**
- `5000` - Web API + UI
- `50054` - gRPC geocode-service
- `50052` - gRPC address-parser
- `50053` - gRPC address-corrector

---

**Примечание:** Все примеры работают на реальной БД с 141,214 зданиями Москвы из OpenStreetMap.
