# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ SQLite

## üöÄ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –£—Å–∫–æ—Ä–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤

**–î–û –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
```
city = '–ú–æ—Å–∫–≤–∞'              : 28.36 ms  (FULL TABLE SCAN)
street LIKE '%–ê—Ä–±–∞—Ç%'        : 43.81 ms  (FULL TABLE SCAN)
city + street                : 28.29 ms  (FULL TABLE SCAN)
```

**–ü–û–°–õ–ï –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
```
city = '–ú–æ—Å–∫–≤–∞'              : 5.09 ms   ‚ö° –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ 5.5x
street = '—É–ª–∏—Ü–∞ –ê—Ä–±–∞—Ç'       : 0.05 ms   ‚ö° –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ 876x!
city + street                : 0.03 ms   ‚ö° –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ 943x!
city + street + house        : 0.05 ms   ‚ö° –ù–æ–≤—ã–π —Å—É–ø–µ—Ä-–±—ã—Å—Ç—Ä—ã–π –∑–∞–ø—Ä–æ—Å
FTS5: '–∞—Ä–±–∞—Ç*'               : 0.24 ms   ‚ö° –í—Å–µ–≥–¥–∞ –±—ã—Å—Ç—Ä–æ
```

---

## 1. –ò–Ω–¥–µ–∫—Å—ã

### –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã:

```sql
-- –û–¥–∏–Ω–æ—á–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_city ON buildings(city);
CREATE INDEX idx_street ON buildings(street);
CREATE INDEX idx_housenumber ON buildings(housenumber);
CREATE INDEX idx_coordinates ON buildings(lat, lon);

-- –°–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã (COVERING INDEX)
CREATE INDEX idx_city_street ON buildings(city, street);
CREATE INDEX idx_city_street_house ON buildings(city, street, housenumber);
```

### –ü–æ—á–µ–º—É —Å–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã?

**–ü–æ–∫—Ä—ã–≤–∞—é—â–∏–π –∏–Ω–¥–µ–∫—Å** (covering index) –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ë–ï–ó –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ:

```sql
-- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç idx_city_street_house –∫–∞–∫ covering index
SELECT city, street, housenumber
FROM buildings
WHERE city = '–ú–æ—Å–∫–≤–∞' AND street = '—É–ª–∏—Ü–∞ –ê—Ä–±–∞—Ç';

-- –ü–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
-- SEARCH buildings USING COVERING INDEX idx_city_street_house
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ –∏–Ω–¥–µ–∫—Å–∞
- –ù–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ (—ç–∫–æ–Ω–æ–º–∏—è I/O)
- –°–∫–æ—Ä–æ—Å—Ç—å: **0.03 ms** –≤–º–µ—Å—Ç–æ **28.29 ms**

---

## 2. FTS5 (Full-Text Search)

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:

```sql
CREATE VIRTUAL TABLE buildings_fts USING fts5(
    full_address,
    city,
    street,
    content='buildings',
    content_rowid='id'
);
```

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è FTS5:

```sql
-- –ü–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
INSERT INTO buildings_fts(buildings_fts) VALUES('optimize');
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** FTS5 –∑–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∑–∞ **0.24-0.74 ms**

---

## 3. PRAGMA –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### WAL —Ä–µ–∂–∏–º (Write-Ahead Logging)

```sql
PRAGMA journal_mode = WAL;
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å
- –ß–∏—Ç–∞—Ç–µ–ª–∏ –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç –ø–∏—Å–∞—Ç–µ–ª–µ–π
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: +30-50% –¥–ª—è –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π

### Cache Size

```sql
PRAGMA cache_size = -64000;  -- 64MB
```

**–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é:** ~2MB
**–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:** 64MB
**–≠—Ñ—Ñ–µ–∫—Ç:** –ë–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö –∫–µ—à–∏—Ä—É–µ—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ ‚Üí –º–µ–Ω—å—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ –¥–∏—Å–∫—É

### Memory-Mapped I/O

```sql
PRAGMA mmap_size = 268435456;  -- 256MB
```

**–≠—Ñ—Ñ–µ–∫—Ç:** –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–µ—à–∏—Ä—É–µ—Ç —Ñ–∞–π–ª –ë–î –≤ –ø–∞–º—è—Ç–∏ ‚Üí –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø

### –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –ø–∞–º—è—Ç–∏

```sql
PRAGMA temp_store = MEMORY;
```

**–≠—Ñ—Ñ–µ–∫—Ç:** –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (JOIN, ORDER BY) —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ RAM –≤–º–µ—Å—Ç–æ –¥–∏—Å–∫–∞

### –†–µ–∂–∏–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

```sql
PRAGMA synchronous = NORMAL;
```

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**
- `OFF`: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å, —Ä–∏—Å–∫ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∫—Ä–∞—Ö–µ
- `NORMAL`: –ë–∞–ª–∞–Ω—Å —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ ‚úÖ
- `FULL`: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å, –º–µ–¥–ª–µ–Ω–Ω–µ–µ

---

## 4. ANALYZE (–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)

```sql
ANALYZE;
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –°–æ–±–∏—Ä–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- –û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ—ë –¥–ª—è –≤—ã–±–æ—Ä–∞ –ª—É—á—à–µ–≥–æ –ø–ª–∞–Ω–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ó–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç **–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã**

---

## 5. VACUUM (–î–µ—Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—è)

```sql
VACUUM;
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –£–¥–∞–ª—è–µ—Ç —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—é
- –û—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ –º–µ—Å—Ç–æ
- **–°—ç–∫–æ–Ω–æ–º–ª–µ–Ω–æ:** 22.91 MB (1137 MB ‚Üí 1114 MB)

---

## 6. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π

### –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ë–î (osm_importer.py)

```python
def create_database(db_path):
    # ... —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü

    # –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —Å—Ä–∞–∑—É
    cursor.execute("CREATE INDEX IF NOT EXISTS idx_city ON buildings(city)")
    cursor.execute("CREATE INDEX IF NOT EXISTS idx_street ON buildings(street)")
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã

    # –ü–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞
    cursor.execute("ANALYZE")
    cursor.execute("PRAGMA journal_mode = WAL")
    cursor.execute("PRAGMA cache_size = -64000")
    cursor.execute("PRAGMA mmap_size = 268435456")
```

### –ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ (advanced_search.py, basic_search.py)

```python
def __init__(self, db_path):
    self.conn = sqlite3.connect(db_path, check_same_thread=False)

    # PRAGMA –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
    cursor = self.conn.cursor()
    cursor.execute("PRAGMA journal_mode = WAL")
    cursor.execute("PRAGMA cache_size = -64000")
    cursor.execute("PRAGMA mmap_size = 268435456")
    cursor.execute("PRAGMA temp_store = MEMORY")
    cursor.execute("PRAGMA synchronous = NORMAL")
```

---

## 7. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ë–î:

–ï—Å–ª–∏ –ë–î —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞ –±–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π, –∑–∞–ø—É—Å—Ç–∏—Ç–µ:

```bash
docker exec geocode-service python add_indexes.py
```

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. –î–æ–±–∞–≤–∏—Ç –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã
2. –í—ã–ø–æ–ª–Ω–∏—Ç ANALYZE
3. –ü—Ä–∏–º–µ–Ω–∏—Ç PRAGMA –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
4. –í—ã–ø–æ–ª–Ω–∏—Ç VACUUM
5. –ü–æ–∫–∞–∂–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

```bash
docker exec geocode-service python analyze_performance.py
```

–°–∫—Ä–∏–ø—Ç –ø–æ–∫–∞–∂–µ—Ç:
- –°–ø–∏—Å–æ–∫ –∏–Ω–¥–µ–∫—Å–æ–≤
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- EXPLAIN QUERY PLAN
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

---

## 8. –ò—Ç–æ–≥–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

| –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è | –ó–Ω–∞—á–µ–Ω–∏–µ | –≠—Ñ—Ñ–µ–∫—Ç |
|-------------|----------|--------|
| –ò–Ω–¥–µ–∫—Å—ã | 6 –∏–Ω–¥–µ–∫—Å–æ–≤ (4 –æ–¥–∏–Ω–æ—á–Ω—ã—Ö + 2 —Å–æ—Å—Ç–∞–≤–Ω—ã—Ö) | –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ 5-900x |
| FTS5 | –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω | 0.24-0.74 ms |
| WAL —Ä–µ–∂–∏–º | –í–∫–ª—é—á–µ–Ω | –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã |
| Cache | 64 MB | –ú–µ–Ω—å—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ –¥–∏—Å–∫—É |
| MMAP | 256 MB | OS-–∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ |
| Temp store | MEMORY | –ë—ã—Å—Ç—Ä—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã |
| ANALYZE | –í—ã–ø–æ–ª–Ω–µ–Ω | –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –ø–ª–∞–Ω—ã –∑–∞–ø—Ä–æ—Å–æ–≤ |
| VACUUM | –í—ã–ø–æ–ª–Ω–µ–Ω | -22.91 MB |

**–†–∞–∑–º–µ—Ä –ë–î:** 1,114 MB (141,214 –∑–¥–∞–Ω–∏–π)
**–í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞:** 0.03-5 ms (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π —Ö–∞–∫–∞—Ç–æ–Ω–∞ ~100 ms)

---

## 9. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π

### –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```bash
docker exec geocode-service sh -c "
  sqlite3 /data/db/moscow.db '
    PRAGMA journal_mode;
    PRAGMA cache_size;
    PRAGMA mmap_size;
    SELECT COUNT(*) as indexes FROM sqlite_master WHERE type=\"index\" AND tbl_name=\"buildings\";
  '
"
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
wal
-64000
268435456
6
```

---

## 10. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è production

1. **–†–µ–≥—É–ª—è—Ä–Ω—ã–π VACUUM:** —Ä–∞–∑ –≤ –º–µ—Å—è—Ü –¥–ª—è –¥–µ—Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏–∏
2. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ANALYZE:** –ø–æ—Å–ª–µ –±–æ–ª—å—à–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –¥–∞–Ω–Ω—ã—Ö
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ cache hit rate:** `PRAGMA cache_hit_rate`
4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:** >10ms
5. **–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:** –µ—Å–ª–∏ –ë–î >10GB, —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —à–∞—Ä–¥–∏–Ω–≥

---

**–ì–æ—Ç–æ–≤–æ!** –í—Å–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤—ã—Ö –ë–î.
