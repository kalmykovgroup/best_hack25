# Обработка ошибок

## Что улучшено

### 1. C# Backend

**PythonSearchClient.cs** - дружественные сообщения об ошибках:
- `Unavailable` → "Сервис поиска временно недоступен. Проверьте, что Python сервис запущен."
- `DeadlineExceeded` → "Превышено время ожидания ответа от сервиса поиска."
- `Internal` → "Внутренняя ошибка сервиса поиска."
- Другие ошибки → "Ошибка при обращении к сервису поиска."

**geocode.proto** - добавлен новый статус:
- `SERVICE_UNAVAILABLE = 7` - для недоступности сервиса

### 2. React Client

Клиент автоматически показывает ошибки в красном блоке под поисковой строкой:
```tsx
{error && (
  <div className="error-message">
    {error}
  </div>
)}
```

## Как работает

```
┌─────────────────────────────────────────────────────┐
│ 1. Python gRPC сервис недоступен                    │
└─────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────┐
│ 2. C# API ловит RpcException (Unavailable)          │
│    PythonSearchClient.cs:69-99                      │
└─────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────┐
│ 3. Возвращает SearchAddressResponse                 │
│    Status.Code = SERVICE_UNAVAILABLE                │
│    Status.Message = "Сервис поиска временно..."     │
└─────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────┐
│ 4. GeocodeHub отправляет ApiResponse с ошибкой      │
│    success = false                                  │
│    errorMessage = Status.Message                    │
└─────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────┐
│ 5. React клиент показывает error в UI               │
│    "Сервис поиска временно недоступен..."           │
└─────────────────────────────────────────────────────┘
```

## Как применить изменения

### Шаг 1: Остановите C# API
Нажмите `Ctrl+C` в терминале где запущен C# API.

### Шаг 2: Пересоберите проект
```bash
cd C:\Users\Apolon 1\RiderProjects\best_hack25\api
dotnet build
```

Это перегенерирует C# классы из обновленного `geocode.proto`.

### Шаг 3: Запустите C# API снова
```bash
dotnet run
```

### Шаг 4: Протестируйте обработку ошибок

#### Тест 1: Python сервис недоступен
1. Убедитесь что Python сервис **НЕ запущен**
2. Откройте http://localhost:5174
3. Введите любой запрос (например "Москва")
4. Должно появиться сообщение: **"Сервис поиска временно недоступен. Проверьте, что Python сервис запущен."**

#### Тест 2: Нормальная работа
1. Запустите Python сервис:
   ```bash
   cd C:\Users\Apolon 1\RiderProjects\best_hack25\python-search
   python grpc_server.py
   ```
2. Обновите страницу http://localhost:5174
3. Введите запрос - должны появиться результаты

## Коды ошибок

| Код | Значение | Когда возникает |
|-----|----------|-----------------|
| `OK` | Успех | Все прошло успешно |
| `INVALID_REQUEST` | Некорректный запрос | Валидация не прошла |
| `NOT_FOUND` | Не найдено | Нет результатов |
| `INTERNAL_ERROR` | Внутренняя ошибка | Неожиданная ошибка |
| `TIMEOUT` | Таймаут | Превышено время ожидания |
| `DATABASE_ERROR` | Ошибка БД | Проблемы с базой данных |
| `CANCELLED` | Отменено | Запрос отменен пользователем |
| `SERVICE_UNAVAILABLE` | Недоступен | Python сервис не отвечает |

## Логи

### C# API (короткие и понятные)
```
info: Api.Hubs.GeocodeHub[0]
      Получен запрос на поиск. RequestId: search_123, Query: Москва

fail: Api.Services.Search.PythonSearchClient[0]
      Ошибка gRPC. StatusCode: Unavailable, Detail: Connection refused
```

### React Client (в консоли браузера F12)
```
[useAddressSearch] Ошибка: Сервис поиска временно недоступен. Проверьте, что Python сервис запущен.
```

## Преимущества

✅ **Устойчивость** - приложение не падает при недоступности Python сервиса
✅ **Понятность** - пользователь видит понятное сообщение вместо stack trace
✅ **Отладка** - технические детали логируются на сервере
✅ **Безопасность** - stack trace не передается клиенту
