# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ gRPC –∫–æ–¥–∞

–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `geocode.proto` –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Python gRPC —Ñ–∞–π–ª—ã.

## –í–∞—Ä–∏–∞–Ω—Ç 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç

```bash
cd python-search
python generate_grpc.py
```

## –í–∞—Ä–∏–∞–Ω—Ç 2: –†—É—á–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞

```bash
cd python-search
python -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. geocode.proto
```

## –í–∞—Ä–∏–∞–Ω—Ç 3: –ß–µ—Ä–µ–∑ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ (–µ—Å–ª–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ)

```bash
cd python-search
.venv\Scripts\activate  # Windows
# –∏–ª–∏
source .venv/bin/activate  # Linux/Mac

python generate_grpc.py
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω—ã/–æ–±–Ω–æ–≤–ª–µ–Ω—ã —Ñ–∞–π–ª—ã:
- `geocode_pb2.py` - —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
- `geocode_pb2_grpc.py` - —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–ª–∏–µ–Ω—Ç—ã –∏ —Å–µ—Ä–≤–µ—Ä—ã gRPC

## –ß—Ç–æ –±—ã–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –≤ proto

–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –ø–æ–ª—è –≤ `SearchAddressRequest`:
```protobuf
message SearchAddressRequest {
  string normalized_query = 1;         // –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å (—á–µ—Ä–µ–∑ Address Parser)
  int32 limit = 2;
  string request_id = 3;
  SearchOptions options = 4;
  string original_query = 5;           // üÜï –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  ParsedAddressComponents parsed_components = 6;  // üÜï –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (libpostal)
}

message ParsedAddressComponents {
  string house_number = 1;  // –ù–æ–º–µ—Ä –¥–æ–º–∞
  string road = 2;          // –£–ª–∏—Ü–∞
  string unit = 3;          // –ö–≤–∞—Ä—Ç–∏—Ä–∞
  string city = 9;          // –ì–æ—Ä–æ–¥
  string postcode = 7;      // –ò–Ω–¥–µ–∫—Å
  string state = 12;        // –†–µ–≥–∏–æ–Ω
  // ... –∏ –¥—Ä—É–≥–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
}
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ Python —Å–µ—Ä–≤–∏—Å–µ

–°–µ—Ä–≤–∏—Å —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å, –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –ò —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

```python
def SearchAddress(self, request, context):
    # –î–æ—Å—Ç—É–ø –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É
    original = request.original_query

    # –î–æ—Å—Ç—É–ø –∫ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É
    normalized = request.normalized_query

    # –î–æ—Å—Ç—É–ø –∫ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º (–∏–∑ libpostal)
    components = request.parsed_components
    city = components.city if components else ""
    road = components.road if components else ""
    house_number = components.house_number if components else ""

    # –õ–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞:
    # 1. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç - –ø–æ–∏—Å–∫ –ø–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º (city, road, house_number)
    # 2. Fallback - –ø–æ–∏—Å–∫ –ø–æ —Å—Ç—Ä–æ–∫–∞–º (normalized_query, original_query)
```

## –ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞

```bash
cd python-search
python grpc_server.py
```

–°–µ—Ä–≤–∏—Å –±—É–¥–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
```
–ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å: original_query='–ú–æ—Å–∫–≤–∞, —É–ª. –¢–≤–µ—Ä—Å–∫–∞—è, 7',
                normalized_query='–ú–æ—Å–∫–≤–∞ —É–ª–∏—Ü–∞ –¢–≤–µ—Ä—Å–∫–∞—è 7',
                limit=10, request_id=...

–ü–æ–∏—Å–∫ –ø–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º: city='–º–æ—Å–∫–≤–∞', road='—Ç–≤–µ—Ä—Å–∫–∞—è', house='7'

–ù–∞–π–¥–µ–Ω–æ 2 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∑–∞ 15ms. –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å: '–ú–æ—Å–∫–≤–∞, —É–ª. –¢–≤–µ—Ä—Å–∫–∞—è, 7',
                                    –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π: '–ú–æ—Å–∫–≤–∞ —É–ª–∏—Ü–∞ –¢–≤–µ—Ä—Å–∫–∞—è 7'
```

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–∏—Å–∫

1. **Address Parser (libpostal)** —Ä–∞–∑–±–∏—Ä–∞–µ—Ç –∞–¥—Ä–µ—Å –Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
   - –í—Ö–æ–¥: "–ú–æ—Å–∫–≤–∞, —É–ª. –¢–≤–µ—Ä—Å–∫–∞—è, –¥. 7"
   - –í—ã—Ö–æ–¥: `{city: "–ú–æ—Å–∫–≤–∞", road: "–¢–≤–µ—Ä—Å–∫–∞—è", house_number: "7"}`

2. **Python —Å–µ—Ä–≤–∏—Å** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è –ø–æ–∏—Å–∫–∞:
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ city + road + house_number ‚Üí –≤—ã—Å–æ–∫–∏–π score
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ city + road ‚Üí —Å—Ä–µ–¥–Ω–∏–π score
   - Fallback: –ü–æ–∏—Å–∫ –ø–æ —Å—Ç—Ä–æ–∫–∞–º (–µ—Å–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –Ω–µ—Ç)

3. **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã** —Ä–∞–Ω–∂–∏—Ä—É—é—Ç—Å—è –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ (score 0.0-1.0)
```
