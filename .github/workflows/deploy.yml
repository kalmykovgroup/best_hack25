name: Deploy to Linux Server (212.193.26.111)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create deployment archive
      run: |
        # Создаем архив из git репозитория (включая wwwroot)
        git archive --format=tar.gz -o besthack25-deploy.tar.gz HEAD

    - name: Copy files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT }}
        source: "besthack25-deploy.tar.gz"
        target: "/tmp"

    - name: Deploy with Docker Compose
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT }}
        command_timeout: 30m  # Увеличиваем таймаут до 30 минут
        script: |
          set -e

          # Переменные
          DEPLOY_DIR="/var/www/besthack25"

          # Создаем директорию если не существует
          mkdir -p $DEPLOY_DIR

          # Создаем бэкап предыдущей версии
          if [ -d "$DEPLOY_DIR/current" ]; then
            echo "Creating backup..."
            rm -rf $DEPLOY_DIR/backup
            mv $DEPLOY_DIR/current $DEPLOY_DIR/backup
          fi

          # Создаем новую директорию
          mkdir -p $DEPLOY_DIR/current

          # Распаковываем новую версию
          echo "Extracting new version..."
          tar -xzf /tmp/besthack25-deploy.tar.gz -C $DEPLOY_DIR/current

          # Переходим в директорию проекта
          cd $DEPLOY_DIR/current

          # Создаем .env файл (используем GitHub Secrets)
          cat > .env << 'ENVEOF'
          # Domain & SSL
          DOMAIN=${{ secrets.DOMAIN }}
          SSL_EMAIL=${{ secrets.SSL_EMAIL }}
          CERTBOT_STAGING=0

          # Nginx
          NGINX_HTTP_PORT=80
          NGINX_HTTPS_PORT=443

          # ASP.NET Core
          ASPNETCORE_ENVIRONMENT=Production

          # CORS
          ALLOWED_ORIGINS=https://${{ secrets.DOMAIN }},http://${{ secrets.DOMAIN }}

          # Geocode Service (BM25 search + встроенный libpostal)
          GEOCODE_SERVICE_PORT=50054
          GEOCODE_SERVICE_GRPC_PORT=50054

          # Service URLs
          PYTHON_SERVICE_URL=http://geocode-service:50054

          # Performance
          ENABLE_VERBOSE_LOGGING=0
          GRPC_TIMEOUT_SECONDS=30
          ENVEOF

          # Создаем директории для certbot
          mkdir -p certbot/www certbot/conf

          # Останавливаем старые контейнеры
          echo "Stopping old containers..."
          docker compose down || true

          # Собираем и запускаем новые контейнеры
          echo "Building and starting containers..."
          docker compose up -d --build

          # Проверяем статус
          echo "Checking container status..."
          docker compose ps

          # Показываем логи
          echo "Recent logs:"
          docker compose logs --tail=50

          # Очистка
          rm -f /tmp/besthack25-deploy.tar.gz

          echo "Deployment completed successfully!"
